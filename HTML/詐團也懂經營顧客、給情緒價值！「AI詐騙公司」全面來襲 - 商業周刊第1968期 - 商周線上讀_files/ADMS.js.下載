"use strict";var isShowDebug=!1,timerList=[],adsInfo=[],allADs=[],loadedImage=[],ScrollObj={scrollView:null,win_h:0,ADMSScroll:function(){}};function toggleADMSCookie(e,t){t="DOM"===t?null!=(t=$("#".concat(e)).val())?t:null:getUrlVar(e);return t?ADMSSetCookie(e,t):ADMSdelCookie(e)}function getCoverAndOverlayAndFloatADs(e){var t=/insert.js|overlay.js|insert_191004.js/g;return e.filter(function(e){return t.test(e.MaterialHtml)})}function init(){var e,t;ADMSgetCookie("device_id")&&ADMSSetCookie("uuid",ADMSgetCookie("device_id")),"undefined"==typeof jQuery?(window.NowPercent=0,e=document.getElementsByTagName("head").item(0),(t=document.createElement("script")).setAttribute("type","text/javascript"),t.setAttribute("src","//code.jquery.com/jquery-3.3.1.min.js"),e.appendChild(t),t.onload=function(){RequestAD()}):$(function(){RequestAD()})}function oneADSectionShow(p){return new Promise(function(e,t){for(var n=0;n<p.length;n++){var i=p[n],o=i.WebSiteId,l=i.ChanelId,r=i.ActivityId,a=i.PanelId,s=i.PurchaseOrderId,c=i.ServingId,d=i.MaterialId,u=i.KeyWord,m=i.SiteChannelId,g=i.SiteId,h=i.isLast,f=i.FrequencyAmount;null!=i.MaterialHtml&&((0<f||-1==f)&&(ADMSSetCookie(c,(-1!=f&&parseInt(ADMSgetCookie(c))||0)+1),ADMSSetCookie(c+"-T",(new Date).getTime())),setImpressionRealRecord(o,l,a,r,s,c,d,g,m,u,!0,0),ShowAD(p[n])),h&&InitScrollShowlLog()}e(!0)})}function sortADResult(e){for(var t,n=[],i=[],o=0;o<e.length;o++)o===e.length-1&&(e[o].isLast=!0),(e[o].MaterialHtml.toLowerCase().includes("//adms")?(e[o].isMine=!0,(t=-1)!==(t=/insert.js|overlay.js|insert_191004.js/g.test(e[o].MaterialHtml)?o:t)&&loadedImage.push(e[o].PanelId),n):(e[o].isMine=!1,i)).push(e[o]);return{mineAD:n,otherAD:i}}function RequestAD(t,e){e=e||1;var n=[];if(null!=(t=t||null)?(panel={pid:t},n.push(panel)):(InitPanel($(".clear_active ")),$(1!=e?'ins[loadType="'+e+'"]:not(".active")':'ins:not(".active")').not("[mid]").each(function(){var e;null!==(t=null!=(e=$(this).attr("pid"))?e:null)&&(e={pid:t},n.push(e),this.style.textDecoration="none")})),n.length)try{ADMSClearFloat(),timerList.forEach(function(e){clearInterval(e.timer)}),$.ajax({type:"Post",url:"//admsapi.businessweekly.com.tw/api/ADMS/",datatype:"json",cache:!1,xhrFields:{withCredentials:!0},beforeSend:function(){ScrollObj={scrollView:null,win_h:0,ADMSScroll:function(){}};[{name:"gtm_isAD",type:"DOM"},{name:"gtm_keywords_hidden",type:"DOM"},{name:"adms_group_list",type:"DOM"},{name:"gtm_siteid",type:"DOM"},{name:"assigndatetime",type:"URL"},{name:"materialid",type:"URL"}].forEach(function(e){return toggleADMSCookie(e.name,e.type)}),ADMSSetCookie("url",window.location.href)},contentType:"application/json; charset=utf-8",data:JSON.stringify(n),success:function(e){timerList=[],loadedImage=[];var t=sortADResult(e).mineAD;allADs=e,adsInfo=getCoverAndOverlayAndFloatADs(t),t.length&&observeOverlayAndBottomAndFloat(),oneADSectionShow(e),intersection()},error:function(e,t){console.log(t)}})}catch(e){console.log("Error: "+e.message)}}function ShowAD(e){var t,n,i,o,l,r,a=e.WebSiteId,s=e.ChanelId,c=e.PanelId,d=e.ActivityId,u=e.PurchaseOrderId,m=e.ServingId,g=e.MaterialId,h=e.MaterialHtml,f=e.KeyWord,p=e.SiteId,v=e.SiteChannelId,e=e.isMine,c=$("ins[pid='".concat(c,"']:not([mid])")).last();0!=c.length&&(null!=(n=c.attr("aid")||null)&&n!=d?(c.attr("WID",a).attr("CID",s).attr("AID",d).attr("POID",u).attr("SID",m).attr("MID",g).attr("KeyWord",f).attr("SiteChannelId",v).attr("SiteId",p).attr("ismine",e),c.parent(".Google-special").remove()):(0<=h.indexOf("@Reload")&&(h=h.replace("@Reload",""),n=document.getElementsByTagName("head").item(0),(t=document.createElement("script")).setAttribute("type","text/javascript"),t.setAttribute("src","//www.businessweekly.com.tw/assets/js/jquery.idle.home.js"),n.appendChild(t)),0<=h.indexOf("@Guid")&&(n=Math.guid(),h=h.replace(/\@Guid/g,n)),h=processhtml(h),$($.parseHTML(h,document,!0)).filter("script").length||-1!=h.indexOf("document.write")?((i=document.createElement("iframe")).setAttribute("style",(o="margin:0;padding:0;overflow:hidden;background-color:transparent;")+"border:none;width:100%;height:100%;"),i.setAttribute("scrolling","no"),i.setAttribute("class","ADMS"),c.html(i),i.contentDocument.open(),i.contentDocument.write(h),l=0,r=setInterval(function(){l++,i.contentDocument&&(i.contentDocument.body?(i.contentDocument.body.setAttribute("style",o),i.contentDocument.close(),clearInterval(r)):20<=l&&(i.contentDocument.close(),clearInterval(r)))},100)):c.html(h),c.attr("WID",a).attr("CID",s).attr("AID",d).attr("POID",u).attr("SID",m).attr("MID",g).attr("KeyWord",f).attr("SiteChannelId",v).attr("SiteId",p).attr("ismine",e)))}function ADMSScroll(){ScrollObj.scrollView&&ScrollObj.scrollView.check(ScrollObj.scrollView.el,ScrollObj.scrollView.h,ScrollObj.win_h)}function InitScrollShowlLog(){var e={init:function(e,t){window.NowPercent=(document.documentElement.scrollTop||document.body.scrollTop)/(document.body.clientHeight-window.innerHeight)*100,ScrollObj.scrollView.el=$(e),ScrollObj.scrollView.h=t,ScrollObj.win_h=window.innerHeight,ScrollObj.scrollView.check(ScrollObj.scrollView.el,ScrollObj.scrollView.h,ScrollObj.win_h),window.addEventListener("load",ScrollObj.ADMSScroll),window.addEventListener("scroll",ScrollObj.ADMSScroll),window.addEventListener("resize",function(){ScrollObj.win_h=window.innerHeight})},check:function(e,t,n){window.NowPercent=(document.documentElement.scrollTop||document.body.scrollTop)/(document.body.clientHeight-window.innerHeight)*100,e.each(function(){var e=$(this);e.offset().top,e.height(),document.documentElement.scrollTop||document.body.scrollTop;e.hasClass("active")||(e.addClass("active"),ScrollObj.scrollView.callback(e))}),$("ins[percentgo][mid]").each(function(){$(this).removeAttr("percentgo"),$(this).trigger("click")}),$("adcover").not(".active").each(function(){var e=$(this);e.offset().top,document.documentElement.scrollTop||document.body.scrollTop;e.hasClass("active")||(e.addClass("active"),0<(e=$("ins[pid='"+$(this).attr("coverpanelId")+"']")).length&&$(e).trigger("click"))})},callback:function(e){var t=$(e).attr("wid")||null,n=$(e).attr("cid")||null,i=$(e).attr("pid")||null,o=$(e).attr("aid")||null,l=$(e).attr("poid")||null,r=$(e).attr("sid")||null,a=$(e).attr("mid")||null,s=$(e).attr("siteid")||null,c=$(e).attr("SiteChannelId")||null,e=$(e).attr("KeyWord")||null;null!==t&&null!==n&&null!==i&&null!==o&&null!==l&&null!==r&&null!==a&&setImpressionReal(t,n,i,o,l,r,a,s,c,e)}};ScrollObj.scrollView=e,ScrollObj.ADMSScroll=ADMSScroll,ScrollObj.scrollView.init("ins[mid]",1)}function getUrlVar(e){e=new RegExp(e+"=([^&]*)","i").exec(window.location.search);return e&&decodeURI(e[1])||""}function processhtml(e){var t=e,n=t.match(/src=\"([^\"]*?)\"/gi);if(null!=n&&(0<n.indexOf("bwnet")||n.indexOf("businessweekly")))for(var i=0;i<n.length;i++)t=t.replace(n[i],n[i].replace(/\https:/g,"").replace(/\http:/g,""));return t}function ADMSSetCookie(e,t){var n=new Date;n.setTime(n.getTime()+2592e6),document.cookie=e+"="+escape(t)+";expires="+n.toGMTString()+";domain=.businessweekly.com.tw;path=/"}function ADMSgetCookie(e){e=document.cookie.match(new RegExp("(^| )"+e+"=([^;]*)(;|$)"));return null!=e?decodeURI(e[2]):null}function ADMSdelCookie(e){var t=new Date;t.setTime(t.getTime()-2592e6),document.cookie=e+"="+escape("N")+";expires="+t.toGMTString()+";domain=.businessweekly.com.tw;path=/"}function SetCwinHeight(e){var t;0<$("div#"+e+" ins iframe.ADMS").length&&(t=$("div#"+e+" ins iframe.ADMS")[0],e=$("div#"+e)[0],t)&&e&&t&&!window.opera&&(t.contentDocument&&t.contentDocument.body.offsetHeight?t.contentDocument.body.offsetHeight>t.height&&e.setAttribute("style","height:"+t.contentDocument.body.offsetHeight+"px"):t.Document&&t.Document.body.scrollHeight&&t.Document.body.scrollHeight>t.height&&e.setAttribute("style","height:"+t.contentDocument.body.offsetHeight+"px"))}function setImpressionRealRecord(e,t,i,n,o,l,r,a,s,c){var d=!(10<arguments.length&&void 0!==arguments[10])||arguments[10],u=11<arguments.length&&void 0!==arguments[11]?arguments[11]:0;if(checkSendImpressionData({Wid:e,Cid:t,Pid:i,Aid:n,POid:o,Sid:l,Mid:r})&&d){if("seeAD"===u){if(!timerList[i])return;if(2<timerList[i].number)return void clearInterval(timerList[i].timer)}var m={0:"api回傳",1:"T1 素材可視第0秒",2:"T2 素材可視第1秒",3:"T3 素材可視第2秒",4:"T4 素材可視第3秒",5:"T5 備用",6:"T6 備用",7:"T7 備用",8:"T8 備用",9:"T9 版位 HTML 異動"},g={w:e,c:t,p:i,a:n,po:o,s:l,m:r,SiteId:a,SiteChannelId:s,KeyWord:c,Timing:"seeAD"===u?{0:2,1:3,2:4,3:5,4:6,5:7,6:8}[timerList[i].number]:u};try{$.ajax({type:"Post",url:"//admsapi.businessweekly.com.tw/Home/SetImpressionTiming/",datatype:"json",cache:!1,xhrFields:{withCredentials:!0},crossDomain:!0,contentType:"application/json; charset=utf-8",data:JSON.stringify(g),success:function(e,t,n){isShowDebug&&console.log("".concat((new Date).toISOString().split("T")[1]," 版位 ").concat(i," : ").concat(m[g.Timing]))},error:function(e,t){console.log("Error:"+t.message)}})}catch(e){console.log("Error: "+e.message)}"seeAD"===u&&timerList[i].number++}}function ADMSCallBack(e,n){$.ajax({type:"Post",url:"//admsapi.businessweekly.com.tw/api/SetADNull/",cache:!1,xhrFields:{withCredentials:!0},crossDomain:!0,contentType:"application/json; charset=utf-8",beforeSend:function(){[{name:"assigndatetime",type:"URL"},{name:"materialid",type:"URL"}].forEach(function(e){return toggleADMSCookie(e.name,e.type)})},data:JSON.stringify({ServingId:e,PanelId:n}),success:function(e){var t;null!=e&&null!=e.PanelId&&($("adcover").last().removeClass("active"),0!=(t=$("ins[pid='".concat(n,"']")).last()).length)&&(t.removeClass("active").removeAttr("wid").removeAttr("cid").removeAttr("aid").removeAttr("poid").removeAttr("sid").removeAttr("mid").removeAttr("ismine"),e.PanelId=e.PanelId.toUpperCase(),ShowAD(e))}})}function ADMSClearFloat(){$("div.insert_bottom").remove();var e=document.getElementById("MediaBookAD2-btn"),e=(null!=e&&$(e).trigger("click"),document.getElementsByClassName("AD2M-task-close")),e=(0<e.length&&$(e).trigger("click"),document.getElementsByClassName("AD2M-CrazyCloseImg")),e=(0<e.length&&$(e).trigger("click"),document.getElementsByClassName("innity-apps-overlay-close-btn")),e=(0<e.length&&$(e).trigger("click"),document.getElementById("cf_close")),e=(null!=e&&$(e).trigger("click"),$("#close_btn,#fixedbox").remove(),$("#DivClose,#CFDiv,#CfBox,#cf_box,#cf_close").remove(),document.getElementById("btn_close_fix"));if(null!=e&&$(e).trigger("click"),0<$("div[id^='oneadIPDFPTag']").length&&$("div[id^='oneadIPDFPTag']").remove(),"undefined"==typeof _ONEAD)console.log("OneAD Ad is not existed.");else{try{setTimeout(function(){ONEAD_closeAd("mobile-incover")},1e3)}catch(e){}e=document.createElement("script");e.setAttribute("type","text/javascript"),e.setAttribute("src","https://ad-specs.guoshipartners.com/static/js/onead-lib.min.js"),document.body.appendChild(e)}0<$("div:contains('Close')").length&&$("div:contains('Close')").trigger("click");e=document.getElementsByClassName("innity-apps-overlay-close-container"),0<e.length&&$(e).trigger("click"),e=document.getElementsByClassName("innity-apps-spin-invitation-close-button"),0<e.length&&$(e).trigger("click"),0<$("#VponMi a img").length&&($("#VponMi a img").trigger("click"),$("#VponMi a img").remove()),e=document.getElementsByClassName("mobile-bottom-carousel-close-btn"),0<e.length&&$(e).trigger("click"),e=document.getElementsByClassName("close-circle-btn");0<e.length&&$(e).trigger("click")}function InitPanel(e){$(e).each(function(e){$(this).removeClass("active").html("").removeAttr("wid").removeAttr("cid").removeAttr("aid").removeAttr("poid").removeAttr("sid").removeAttr("mid").removeAttr("KeyWord").removeAttr("SiteChannelId").removeAttr("SiteId").removeAttr("ismine")})}function checkADShow(e){var t;return 20<(null==e||null==(t=e.boundingClientRect)?void 0:t.width)&&20<(null==e||null==(t=e.boundingClientRect)?void 0:t.height)||20<(null==e?void 0:e.offsetWidth)&&20<(null==e?void 0:e.offsetHeight)}function intersection(){var t=new IntersectionObserver(function(e,t){e.forEach(function(e){var t=checkADShow(e),n=e.target,i=n.getAttribute("wid")||null,o=n.getAttribute("cid")||null,l=n.getAttribute("pid")||null,r=n.getAttribute("aid")||null,a=n.getAttribute("poid")||null,s=n.getAttribute("sid")||null,c=n.getAttribute("mid")||null,d=n.getAttribute("siteid")||null,u=n.getAttribute("SiteChannelId")||null,m=n.getAttribute("KeyWord")||null;n.getAttribute("ismine");e.isIntersecting&&t?.5<=e.intersectionRatio&&!timerList[l]&&l&&(setImpressionRealRecord(i,o,l,r,a,s,c,d,u,m,e.isIntersecting,1),timerList[l]={number:0,timer:setInterval(function(){setImpressionRealRecord(i,o,l,r,a,s,c,d,u,m,e.isIntersecting,"seeAD")},1e3)}):e.isIntersecting||timerList[l]&&clearInterval(timerList[l].timer)})},{rootMargin:"0px",threshold:.5});document.querySelectorAll("ins").forEach(function(e){t.observe(e)})}function observeOverlayAndBottomAndFloat(){new MutationObserver(function(e){e.forEach(function(f){var e;f.target.classList.contains("unfold")&&f.target.classList.contains("open")&&(e=adsInfo.findIndex(function(e){return e.MaterialHtml.includes("sideUnfold")}),adsInfo[e].show=!0),f.target.classList.contains("unfold")&&!f.target.classList.contains("open")&&(e=adsInfo.findIndex(function(e){return e.MaterialHtml.includes("sideUnfold")}),adsInfo[e].show=!1),f.addedNodes.forEach(function(e){if("INS"===f.target.tagName){var t=f.target,n=t.getAttribute("wid")||null,i=t.getAttribute("cid")||null,o=t.getAttribute("pid")||null,l=t.getAttribute("aid")||null,r=t.getAttribute("poid")||null,a=t.getAttribute("sid")||null,s=t.getAttribute("mid")||null,c=t.getAttribute("siteid")||null,d=t.getAttribute("SiteChannelId")||null,t=t.getAttribute("KeyWord")||null;if(loadedImage.includes(o))return;loadedImage.push(o),setImpressionRealRecord(n,i,o,l,r,a,s,c,d,t,!0,9)}if(null!=e&&null!=(n=e.classList)&&n.contains("insert_bottom")||null!=e&&null!=(i=e.classList)&&i.contains("overlay_wrap_adms")){for(var u=["overlayFn","basicBottom"],m=-1,g=0;g<adsInfo.length;g++)for(var h=0;h<u.length;h++)adsInfo[g].MaterialHtml.includes(u[h])&&(m=g);adsInfo[m].show=!0}}),f.removedNodes.forEach(function(e){var t;if(null!=e&&null!=(t=e.classList)&&t.contains("insert_bottom")||null!=e&&null!=(t=e.classList)&&t.contains("overlay_wrap_adms")||null!=e&&null!=(t=e.classList)&&t.contains("unfold")){for(var n=["sideUnfold","overlayFn","basicBottom"],i=-1,o=0;o<adsInfo.length;o++)for(var l=0;l<n.length;l++)adsInfo[o].MaterialHtml.includes(n[l])&&(i=o);adsInfo[i].show=!1}})})}).observe(document.querySelector("body"),{subtree:!0,childList:!0,attributes:!0,attributeFilter:["style","class"]});for(var e=0;e<adsInfo.length;e++)!function(m){Object.defineProperty(adsInfo[m],"show",{get:function(){return adsInfo[m].show},set:function(e){var t=adsInfo[m],n=t.WebSiteId,i=t.ChanelId,o=t.PanelId,l=t.ActivityId,r=t.PurchaseOrderId,a=t.ServingId,s=t.MaterialId,c=t.SiteId,d=t.SiteChannelId,u=t.KeyWord;t.isMine;!e&&timerList[o]?clearInterval(timerList[o].timer):!timerList[o]&&o&&e&&(setImpressionRealRecord(n,i,o,l,r,a,s,c,d,u,e,1),timerList[o]={number:0,timer:setInterval(function(){setImpressionRealRecord(n,i,o,l,r,a,s,c,d,u,e,"seeAD")},1e3)})}})}(e)}function setImpressionReal(e,t,i,n,o,l,r,a,s,c){if(checkSendImpressionData({Wid:e,Cid:t,Pid:i,Aid:n,POid:o,Sid:l,Mid:r})){e={w:e,c:t,p:i,a:n,po:o,s:l,m:r,SiteId:a,SiteChannelId:s,KeyWord:c};try{$.ajax({type:"Post",url:"//admsapi.businessweekly.com.tw/Home/SetImpressionReal/",datatype:"json",cache:!1,xhrFields:{withCredentials:!0},crossDomain:!0,contentType:"application/json; charset=utf-8",data:JSON.stringify(e),success:function(e,t,n){isShowDebug&&console.log("".concat((new Date).toISOString().split("T")[1]," 版位 ").concat(i," : 真實曝光"))},error:function(e,t){console.log("Error:"+t.message)}})}catch(e){console.log("Error: "+e.message)}}}function checkSendImpressionData(e){var t=e.Wid,n=e.Cid,i=e.Pid,o=e.Aid,l=e.POid,r=e.Sid,e=e.Mid;if(null===t||null===n||null===i||null===o||null===l||null===r||null===e)return!1;for(var a=["assigndatetime","materialid"],s=0;s<a.length;s++)if(getUrlVar(a[s]).length)return!1;return!0}function getMaterialAllData(t){var e=allADs.filter(function(e){return e.PanelId===t})[0];setImpressionRealRecord(e.WebSiteId,e.ChanelId,e.PanelId,e.ActivityId,e.PurchaseOrderId,e.ServingId,e.MaterialId,e.SiteId,e.SiteChannelId,e.KeyWord,!0,9)}Math.guid=function(){return"xxxxxxxx-xxxx-0xxx-yxyx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return t.toString(16)}).toUpperCase()},init();